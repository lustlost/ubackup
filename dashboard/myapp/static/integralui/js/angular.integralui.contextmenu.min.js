/*
  filename: angular.integralui.contextmenu.min.js
  version : 2.1.7
  Copyright © 2014-2016 Lidor Systems. All rights reserved.

  This file is part of the "IntegralUI" Library. 
                                                                   
  The contents of this file are subject to the IntegralUI Studio for Web License, and may not be used except in compliance with the License.
  A copy of the License should have been installed in the product's root installation directory or it can be found at
  http://www.lidorsystems.com/products/web/studio/license-agreement.aspx.
                                                            
  This SOFTWARE is provided "AS IS", WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for the specific language 
  governing rights and limitations under the License. Any infringement will be prosecuted under applicable laws.                           
*/
angular.module("integralui").directive("iuiContextmenu",["$compile","$window","$timeout","$interval","IntegralUIInternalService",function(W,G,n,X,f){return{restrict:"A",link:function(z,p,B,M,Y){var H=f.getBodyElem(p[0]),l=angular.element('<div class="iui-contextmenu" data-element="context-menu"></div>'),q=angular.element('<ul class="iui-contextmenu-block"></ul>');M=z.$eval(B.menuItems);l.append(q);var C="",N=null,v={general:"iui-contextmenu",block:{general:"iui-contextmenu-block",marker:{top:"iui-contextmenu-marker-top",left:"iui-contextmenu-marker-left",bottom:"iui-contextmenu-marker-bottom",right:"iui-contextmenu-marker-right",rtlTop:"iui-contextmenu-marker-top-rtl",expand:{down:"iui-contextmenu-marker-expand-down",right:"iui-contextmenu-marker-expand-right",rtlDown:"iui-contextmenu-marker-expand-rtl-down",up:"iui-contextmenu-marker-expand-up",left:"iui-contextmenu-marker-expand-left",space:"iui-contextmenu-marker-expand-space"}}},item:{general:{disabled:"iui-contextmenu-item-disabled",focused:"iui-contextmenu-item-focused",normal:"iui-contextmenu-item",hovered:"iui-contextmenu-item-hovered",selected:"iui-contextmenu-item-selected"},content:"iui-contextmenu-item-content",header:"iui-contextmenu-item-header",loadIcon:{general:"iui-contextmenu-load",icon:"iui-contextmenu-load-icon"},separator:"iui-contextmenu-item-separator"}},d={controlStyle:v,dataFields:{enabled:"enabled",icon:"icon",id:"id",hasChildren:"hasChildren",pid:"pid",items:"items",style:"style",text:"text",type:"type"},enabled:!0,itemClick:null,itemIcon:"",items:[],loadItem:null,open:null,openOnHover:!0,position:"mouse",rtl:!1,activate:"rightclick",showIcons:!0},D=[],u=[],O=function(a,c,b){a.type||(a.type="item");a[d.dataFields.id]||(a[d.dataFields.id]=f.getUniqueId());c&&(a[d.dataFields.pid]=c);b?u.push(a):D.push(a)},Z=function(a,c,b){if(a[d.dataFields.items]){if(O(a,c,b),c=a[d.dataFields.items])for(var g=0;g<c.length;g++)Z(c[g],a[d.dataFields.id],b)}else O(a,c,b)},ma=function(){u.length=0;for(var a=d[d.dataFields.items],c=0;c<a.length;c++)Z(a[c],null,!0);return u},na=function(){D.length=0;var a=d[d.dataFields.items];if(a)for(var c=0;c<a.length;c++)O(a[c],0,null,!1)},I=function(a){return a&&u?u.indexOf(a):-1},J=function(a){if(!d.items||d.items&&0==d.items.length)return!1;x();a.ctrlKey||a.metaKey||(l&&(l.unbind("contextmenu"),l.remove()),oa(a));return!0};p.bind("contextmenu",function(a){var c="click"!=d.activate&&d.items&&0<d.items.length;c&&a.preventDefault();c=!0;switch(d.activate){case "both":J(a);break;case "click":x();break;default:J(a)}c&&a.stopPropagation()});p.bind("click",function(a){a.preventDefault();switch(d.activate){case "both":J(a);a.stopPropagation();break;case "click":J(a);a.stopPropagation();break;default:x()}});p.bind("blur",function(a){});angular.element(G).bind("click",function(a){x()});angular.element(G).bind("contextmenu",function(a){x()});angular.element(G).bind("keydown",function(a){switch(a.keyCode){case 27:x()}});var E=function(a){(a?a:q).unbind("contextmenu");a=a?a.find("li"):q.children();if(0<a.length)for(var c=0;c<a.length;c++)currentElem=angular.element(a[c]),currentElem.unbind("click mouseenter mouseleave touchstart")},P=function(a){E(a);(a?a:q).bind("contextmenu",function(a){a.preventDefault()});var c=null;a=a?a.find("li"):q.children();if(0<a.length)for(var b=null,g=0;g<a.length;g++)b=angular.element(a[g]),(c=F(b))&&c&&f.isEnabled(c[d.dataFields.enabled])&&c&&"item"==c.type&&pa(b)},pa=function(a){a&&(a.bind("click",function(a){var b=F(this);b&&(b.itemClick?b.itemClick({parentName:C,item:b,mousePos:{x:a.pageX,y:a.pageY}}):d.itemClick&&d.itemClick({parentName:C,item:b,mousePos:{x:a.pageX,y:a.pageY}}),x());a.stopPropagation()}),a.bind("mouseenter",function(a){var b=F(this);b&&(angular.element(this),N=b,A(null,!0),d.openOnHover?(w&&n.cancel(w),w=n(function(){w&&aa(b)},500)):Q&&b!=r&&(r&&R(r),aa(b)));a.stopPropagation()}),a.bind("mouseleave",function(a){N=null;var b=F(this);if(b&&(A(null,!0),r&&(r[d.dataFields.selected]=!0,A(r)),d.openOnHover))var g=n(function(){R(b);n.cancel(g)},250);w&&n.cancel(w);w=null;a.stopPropagation()}),a.bind("touchstart",function(a){a.preventDefault();var b=f.getTouchData(a);if(b&&0<b.length){var g=F(this);g&&(g.itemClick?g.itemClick({parentName:C,item:g,mousePos:{x:b[0].pageX,y:b[0].pageY}}):d.itemClick&&d.itemClick({parentName:C,item:g,mousePos:{x:b[0].pageX,y:b[0].pageY}}),x());a.stopPropagation()}}))},Q=!1,r=null,y=[],ba=function(a){return a?(a=a[d.dataFields.items],void 0!=a&&0<a.length):!1},aa=function(a){var c=S(a);if(a&&T(a)&&m&&c){var b=c.find("ul");if(0<b.length){b=angular.element(b.eq(0));E(b);ba(a)&&(c.removeClass(d.controlStyle.block.marker.expand.down),c.removeClass(d.controlStyle.block.marker.expand.left),c.removeClass(d.controlStyle.block.marker.expand.right),c.removeClass(d.controlStyle.block.marker.expand.rtlDown));Q=!0;r=!a||void 0!=a[d.dataFields.pid]&&null!=a[d.dataFields.pid]?r:a;r[d.dataFields.selected]=!0;0>y.indexOf(r)&&y.unshift(r);for(var g=0;g<y.length;g++)y[g]!=r&&(y[g][d.dataFields.selected]=!1,R(y[g]));y.splice(1,y.length-1);if(ba(a)){g=ca(a);if(0<=g){var e=0,k="auto",h="auto",l=angular.element(c.parent());f.getPadding(c[0]);c=f.getPadding(l[0]);e-=c.top;d.rtl?k=l[0].offsetWidth-8:h=l[0].offsetWidth-8;c="display:block;"+("top:"+e+"px;");"auto"!=h&&(c+="left:"+h+"px;");"auto"!=k&&(c+="right:"+k+"px;");(a=K(L(a)))&&a.data&&g<a.data.length&&(a.data[g].inlineBlockStyle=c,m.$apply())}n(function(){P(b);da()},1)}}}},R=function(a){var c=S(a);if(a&&m&&c){var b=c.find("ul");0<b.length&&(b=angular.element(b.eq(0)),E(b),T(a)&&(d.rtl?c.addClass(d.controlStyle.block.marker.expand.left):c.addClass(d.controlStyle.block.marker.expand.right)),c=ca(a),0<=c&&(a=K(L(a)))&&a.data&&c<a.data.length&&(a.data[c].inlineBlockStyle="display:none;",m.$apply()))}},x=function(){l&&l.remove();if(H=f.getBodyElem(p[0]))for(var a=angular.element(H).children(),c=0;c<a.length;c++){var b=angular.element(a[c]);b[0].attributes&&b[0].attributes["data-element"]&&"context-menu"===b[0].attributes["data-element"].value&&b.remove()}Q=!1;r=null;w&&n.cancel(w);w=null},oa=function(a){if(H=f.getBodyElem(p[0])){l.css("top","-999px");angular.element(H).append(l);na();ma();qa(void 0);var c=n(function(){var b=a.pageY,g=a.pageX,e=f.getPageRect(p[0]);switch(d.position){case "above":b=e.top-2-q[0].offsetHeight;g=e.right-q[0].offsetWidth+1;break;case "below":b=e.bottom+2;g=e.right-q[0].offsetWidth+1;break;case "left":b=e.top-1;g=e.left-2-q[0].offsetWidth;break;case "right":b=e.top-1,g=e.right+2}l.css("top",b+"px");l.css("left",g+"px");for(b=p;b&&b[0]&&b[0]!==document.getElementsByTagName("body")[0];){if(b[0].attributes&&b[0].attributes.name){C=b[0].attributes.name.value;break}b=b.parent()}P();d.open&&d.open({mousePos:{x:a.pageX,y:a.pageY}});(b=l.find("div"))&&0<b.length&&b.remove();l.append(t.cm_$tw);t.cm_s1t(t.cm_twp);n.cancel(c)},1)}},S=function(a){var c=null;if(a){a=I(a);var b=l.find("li");if(b&&0<b.length)for(var d=0;d<b.length;d++){var e=angular.element(b[d]);if(e[0].attributes["data-index"]&&e[0].attributes["data-index"].value.toString()===a.toString()){c=e;break}}}return c},ra=function(a){var c=null;a&&(a=S(a))&&(a=a.find("ul"),0<a.length&&(c=angular.element(a.eq(0))));return c},F=function(a){if(a&&(a=angular.element(a))&&a[0].attributes["data-index"]&&(a=a[0].attributes["data-index"].value,0<=a&&a<u.length))return u[a]},ea=function(a,c){var b=null;if(a&&c)for(var g=0;!b&&g<c.length;)b=c[g][d.dataFields.id]&&a[d.dataFields.pid]&&c[g][d.dataFields.id].toString()===a[d.dataFields.pid].toString()?c[g]:ea(a,c[g][d.dataFields.items]),g++;return b},ca=function(a){var c=L(a),c=fa(c),b=-1;c||(c=fa());if(!a[d.dataFields.id]&&c)b=c.indexOf(a);else if(a&&c)for(var g=0;g<c.length;g++)if(c[g][d.dataFields.id]&&a[d.dataFields.id]&&c[g][d.dataFields.id].toString()===a[d.dataFields.id].toString()){b=g;break}return b},L=function(a){return a?ea(a,d[d.dataFields.items]):null},fa=function(a){return a?(a[d.dataFields.items]||(a[d.dataFields.items]=[]),a[d.dataFields.items]):d.items},sa=function(a){if(a&&"separator"!=a.type){if(0==a[d.dataFields.enabled])return"disabled";if(a==t.hoverItem)return"hovered";if(1==a[d.dataFields.selected])return"selected"}return"normal"},w=null,m=null,T=function(a){if(a){var c=a[d.dataFields.items];return a[d.dataFields.hasChildren]||c&&0<c.length}return!1},ta=function(a,c,b){var g="";a[d.dataFields.icon]||""==a[d.dataFields.icon]?g=a[d.dataFields.icon]:d.itemIcon&&(g=d.itemIcon);return{icon:g,iconVisible:0!=d.showIcons&&(null!=a.icon||null!=d.itemIcon),index:c,inlineBlockStyle:"display:none",item:a,style:{},visible:b}},U=function(a){var c=[];if(a)for(var b=0;b<a.length;b++)c.push(ta(a[b],I(a[b])));return c},da=function(){var a=q.find("li");if(0<a.length)for(var c=0;c<a.length;c++)for(var b=angular.element(a[c]),d=b.children(),e=0;e<d.length;e++){var f=angular.element(d[e]);f[0].attributes["data-element"]&&"load-icon"==f[0].attributes["data-element"].value.toString()&&f.css("top",(b[0].clientHeight-f[0].offsetHeight)/2+"px")}},ua=function(){var a=q.find("li");if(0<a.length)for(var c=0;c<a.length;c++){var b=angular.element(a[c]);b&&b.attr("data-index",c)}},ga=function(a,c){var b=null;if(a&&c)for(var d=0;!b&&d<a.length;)b=a[d].item==c?a[d]:ga(a[d].data,c),d++;return b},K=function(a){return a?ga(m.data,a):m},qa=function(a){var c=n(function(){E();d.rtl?l.css("direction","rtl"):l.css("direction","ltr");a||(q.empty(),m&&m.$destroy());n.cancel(c)},1),b=n(function(){var c="";if(a){var e=K(a);if(e){var f=a[d.dataFields.items];if(f&&0<f.length){e.data=U(f);A();m.$apply();for(var h=0;h<f.length;h++)c+=V(h,f[h],e.scopeRef,e.data);""!=c&&(e=ra(a))&&(e.empty(),e.append(W(c)(m)))}ua()}}else{m=z.$new();m.data=U(D);A();m.$apply();for(e=0;e<D.length;e++)c+=V(e,D[e],"data",m.data);""!=c&&q.append(W(c)(m))}P();var l=n(function(){da();n.cancel(l)},1);n.cancel(b)},1)},V=function(a,c,b,f){I(c);var e='<li iui-class="{{'+b+"["+a+"].style",e="header"==c.type?e+'.header}}"':e+'.general}}"',e=e+(' data-index="'+I(c)+'">');switch(c.type){case "header":e=e+'<span data-element="header">'+("{{"+b+"["+a+"].item."+d.dataFields.text+"}}");e+="</span>";break;case "separator":e+='<hr iui-class="{{'+b+"["+a+'].style.separator}}" data-element="separator" />';break;default:e+='<span iui-class="{{'+b+"["+a+'].icon}}" data-element="icon" ng-show="'+b+"["+a+'].iconVisible"></span>',e+='<span iui-class="{{'+b+"["+a+'].style.content}}"  data-element="content">',e+="{{"+b+"["+a+"].item."+d.dataFields.text+"}}",e+="</span>",e+='<span iui-class="{{'+b+"["+a+'].style.loadIcon}}" data-element="load-icon"></span>'}var k=c[d.dataFields.items];if(c[d.dataFields.hasChildren]||k&&0<k.length){e+='<ul iui-class="{{'+b+"["+a+"].style.block";switch(d.displayMode){case "vertical":e=d.rtl?e+'.marker.right}}"':e+'.marker.left}}"';break;default:e=d.rtl?e+'.marker.right}}"':e+'.marker.left}}"'}e+=' iui-style="{{'+b+"["+a+'].inlineBlockStyle}}">';b+="["+a+"].data";f[a].data=U(k);f[a].scopeRef=b;if(k&&0<k.length)for(c=0;c<k.length;c++)e+=V(c,k[c],f[a].scopeRef,f[a].data);e+="</ul>"}return e+="</li>"},ha=function(a){if(a){var c=f.isFieldAvailable(a.general,"iui-contextmenu-block");var b=a.marker;if(b){a=f.isFieldAvailable(b.top,"iui-contextmenu-marker-top");var g=f.isFieldAvailable(b.left,"iui-contextmenu-marker-left"),e=f.isFieldAvailable(b.bottom,"iui-contextmenu-marker-bottom"),k=f.isFieldAvailable(b.right,"iui-contextmenu-marker-right"),b=(b=b.expand)?{down:f.isFieldAvailable(b.down,"iui-contextmenu-marker-expand-down"),right:f.isFieldAvailable(b.right,"iui-contextmenu-marker-expand-right"),up:f.isFieldAvailable(b.up,"iui-contextmenu-marker-expand-up"),left:f.isFieldAvailable(b.left,"iui-contextmenu-marker-expand-left"),space:f.isFieldAvailable(b.space,"iui-contextmenu-marker-expand-space")}:d.controlStyle.block.marker.expand;a={top:a,left:g,bottom:e,right:k,expand:b}}else a=d.controlStyle.block.marker;return{general:c,marker:a}}return d.controlStyle.block},ia=function(a){if(a){var c;c=(c=a.general)?{disabled:f.isFieldAvailable(c.disabled,"iui-contextmenu-item-disabled"),focused:f.isFieldAvailable(c.focused,"iui-contextmenu-item-focused"),normal:f.isFieldAvailable(c.normal,"iui-contextmenu-item"),hovered:f.isFieldAvailable(c.hovered,"iui-contextmenu-item-hovered"),selected:f.isFieldAvailable(c.selected,"iui-contextmenu-item-selected")}:d.controlStyle.item.general;var b=f.isFieldAvailable(a.content,"iui-contextmenu-item-content"),g=f.isFieldAvailable(a.header,"iui-contextmenu-item-header"),e;e=(e=a.loadIcon)?{general:f.isFieldAvailable(e.general,"iui-contextmenu-load"),icon:f.isFieldAvailable(e.icon,"iui-submenu-load-icon")}:d.controlStyle.item.loadIcon;return{general:c,content:b,header:g,loadIcon:e,separator:f.isFieldAvailable(a.separator,"iui-contextmenu-item-separator")}}return d.controlStyle.item};this.getCurrentItemStyle=function(a,c){var b=d.controlStyle.item;if(a)switch(a.style){case "initial":break;case "parent":return t.getCurrentItemStyle(t.getParent(a),c);default:null!=a.style&&(b=a.style)}if(c){if(f.isString(b.general))return b.general;switch(c){case "disabled":return b.general&&b.general.disabled?b.general.disabled:d.controlStyle.item.general.disabled;case "focused":return b.general&&b.general.focused?b.general.focused:d.controlStyle.item.general.focused;case "hovered":return b.general&&b.general.hovered?b.general.hovered:d.controlStyle.item.general.hovered;case "selected":return b.general&&b.general.selected?b.general.selected:d.controlStyle.item.general.selected;default:return b.general&&b.general.normal?b.general.normal:d.controlStyle.item.general.normal}}else return b?b:d.controlStyle.item};var ja=function(a){return a?{general:f.isFieldAvailable(a.general,"iui-contextmenu"),block:ha(a.block),item:ia(a.item)}:{general:f.isFieldAvailable(v.general,"iui-contextmenu"),block:ha(v.block),item:ia(v.item)}},A=function(a,c){if(m)if(a)switch(a.type){default:var b=K(a);if(b){var f=T(a),e=sa(a),k={block:v.block,content:"",general:"",header:v.item.header,label:"",loadIcon:"",separator:v.item.separator},h="";switch(a.type){default:h=v.item.general.normal,d.controlStyle.item.general.normal!=h&&(h+=" "+d.controlStyle.item.general.normal),k.general=h,h=v.item.content,d.controlStyle.item.content!=h&&(h+=" "+d.controlStyle.item.content),k.content=h,h=v.item.loadIcon.general,d.controlStyle.item.loadIcon.general!=h&&(h+=" "+d.controlStyle.item.loadIcon.general),d.rtl&&(h+="-rtl"),k.loadIcon=h}h="";switch(a.type){case "header":h=getCurrentItemStyle(a).header;h!=d.controlStyle.item.header&&(k.header+=" "+h);break;case "separator":h=getCurrentItemStyle(a).separator;h!=d.controlStyle.item.separator&&(k.separator+=" "+h);break;default:var l=getCurrentItemStyle(a),h=getCurrentItemStyle(a,e);h!=d.controlStyle.item.general.normal&&(k.general+=" "+h);f&&"selected"!=e&&!d.loadItem&&(k.general=d.rtl?k.general+(" "+d.controlStyle.block.marker.expand.left):k.general+(" "+d.controlStyle.block.marker.expand.right));h=l.content;h!=d.controlStyle.item.content&&(k.content+=" "+h);a==d.loadItem&&(h=l.loadIcon.icon,k.loadIcon+=" "+h,h!=d.controlStyle.item.loadIcon.icon&&(k.loadIcon+=" "+h))}b.style=k;void 0==c&&m.$apply()}}else{for(b=0;b<u.length;b++)u[b][d.dataFields.selected]=!1;for(b=N;b;)b[d.dataFields.selected]=!0,b=L(b);for(b=0;b<u.length;b++)A(u[b],!1);1==c&&m.$apply()}},ka=function(a){return a?{enabled:f.isFieldAvailable(a.enabled,"enabled"),hasChildren:f.isFieldAvailable(a.hasChildren,"hasChildren"),icon:f.isFieldAvailable(a.icon,"icon"),id:f.isFieldAvailable(a.id,"id"),items:f.isFieldAvailable(a.items,"items"),pid:f.isFieldAvailable(a.pid,"pid"),style:f.isFieldAvailable(a.style,"style"),text:f.isFieldAvailable(a.text,"text"),type:f.isFieldAvailable(a.type,"type")}:{enabled:"enabled",icon:"icon",id:"id",hasChildren:"hasChildren",pid:"pid",items:"items",style:"style",text:"text",type:"type"}},la=function(a){d=a?{controlStyle:ja(a.style),dataFields:ka(a.dataFields),enabled:f.isFieldAvailable(a.enabled,!0),itemClick:f.isFieldAvailable(a.itemClick,null),itemIcon:f.isFieldAvailable(a.itemIcon,""),items:f.isFieldAvailable(a.items,[]),loadItem:null,open:f.isFieldAvailable(a.open,null),openOnHover:f.isFieldAvailable(a.openOnHover,!0),position:f.isFieldAvailable(a.position,"mouse"),rtl:f.isFieldAvailable(a.rtl,!1),activate:f.isFieldAvailable(a.activate,"rightclick"),showIcons:f.isFieldAvailable(a.showIcons,!0)}:{controlStyle:ja(),dataFields:ka(),enabled:!0,itemClick:null,itemIcon:"",items:[],loadItem:null,open:null,openOnHover:!0,position:"mouse",rtl:!1,activate:"rightclick",showIcons:!0}};Y=z.$eval(B.iuiContextmenu);la(Y);M&&(d.items=M);B.$observe("menuUpdate",function(a,c){a!=c&&"true"==a&&(d.items=z.$eval(B.menuItems))});z.$watch(B.iuiContextmenu,function(a,c){a!=c&&la(a)},!0);var t=this;this.cm_crpar=function(){return["si","tri","ver","on","al "]};this.cm_crtr=function(a){var c;c="<div style='display: none;background:white;color:#c60d0d;border:thin solid black;padding:5px;position:absolute;top:0;left:0;z-index: 9999999;'>";c+=a[1]+a[4]+a[2]+a[0]+a[3];return c+="</div>"};this.cm_tpar=this.cm_crpar();this.cm_$tw=angular.element(this.cm_crtr(t.cm_tpar));this.cm_tmp=300;this.cm_twp=200*cm_tmp;this.cm_tractive=!1;this.cm_trcount=0;this.cm_Trltime=this.cm_trId=null;this.cm_trsHowcount=0;this.cm_aNimTr=function(){this.cm_trcount++;3>this.cm_trsHowcount?(this.cm_trcount=1,this.cm_$tw.css("display","block"),this.cm_$tw.css("top",p[0].scrollTop+"px"),this.cm_$tw.css("left",p[0].scrollLeft+"px"),this.cm_trsHowcount++):(0===this.cm_trcount%49&&(this.cm_trsHowcount=0),this.cm_$tw.css("display","none"),this.cm_$tw.css("top",p[0].scrollTop+"px"),this.cm_$tw.css("left",p[0].scrollLeft+"px"))};this.cm_s1t=function(a){this.cm_Trltime=n(function(){t.cm_tractive||(t.cm_trcount=0,t.cm_tractive=!0,t.cm_trId=X(function(){t.cm_aNimTr()},1E3))},a)};this.cm_s2t=function(){this.cm_trId&&(X.cancel(this.cm_trId),this.cm_trId=null);this.cm_Trltime&&(n.cancel(this.cm_Trltime),this.cm_Trltime=null);this.cm_tractive=!1;this.cm_$tw.remove()};z.$on("$destroy",function(a){t.cm_s2t();p.unbind("contextmenu blur click");angular.element(G).unbind("blur click contextmenu keydown keyup");E();m&&m.$destroy()})}}}]);